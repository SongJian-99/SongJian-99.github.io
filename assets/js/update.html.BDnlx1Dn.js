import{_ as s}from"./plugin-vue_export-helper.DlAUqK2U.js";import{c as a,a as e,o as t}from"./app.D_qosN0g.js";const n={};function l(h,i){return t(),a("div",null,i[0]||(i[0]=[e(`<h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><p>开发环境一个微服务模块所有接口请求报错，对应页面无法访问。其他未涉及到该模块的接口和页面访问正常。</p><p>最近未更新过该服务，之前该服务也没有发生过不可用的情况。</p><h2 id="错误排查" tabindex="-1"><a class="header-anchor" href="#错误排查"><span>错误排查</span></a></h2><p>根据所观察到的现象和临时思考判断，可以确定是单个服务出现故障，具体原因尚不清楚。</p><h3 id="查看日志" tabindex="-1"><a class="header-anchor" href="#查看日志"><span>查看日志</span></a></h3><p>日志是我们排查问题时的第一个入口，根据日志信息，可以进一步定位问题。</p><ul><li>登陆到远程服务器，执行如下命令，查看容器日志。</li></ul><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ps</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> //</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 查看容器</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> id</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> logs</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --tail</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2000</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 容器id</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">		//</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 查看容器最后2000行日志</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>日志中显示的报错信息如下</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">org</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">springframework</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">jdbc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">CannotGetJdbcConnectionException</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Failed</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> to obtain </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">JDBC</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> Connection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> nested exception is </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">java</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">sql</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">SQLTransientConnectionException</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> HikariPool</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Connection</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> is not available</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> request timed out after 30000ms</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><p>报错信息显示连接池请求数据库连接超时，有几种可能的原因会导致该错误：</p><p>1、网络或数据库故障，这也是最先被排除的原因，因为其他微服务运行正常，说明网络连接没问题、数据库也没故障宕机。</p><p>2、连接池配置不足，因为业务本身请求量并不大，同时也查看了连接池的相关配置，并未发现问题，因此这种原因可能性较小，但不排除；</p><p>3、连接池最大活跃连接数达到了上限。连接池的配置基本没有问题，但有可能因为异常情况导致连接数达到了上限，这个原因可能性相对来说最高，但还要观察数据库的运行情况，收集更多信息才能进行下一步判断。</p></li></ul><h3 id="连接数据库" tabindex="-1"><a class="header-anchor" href="#连接数据库"><span>连接数据库</span></a></h3><p>information_schema 数据库下有几张表可以帮助我们收集数据库的运行情况。</p><ol><li>查看当前数据库运行的所有事务，确认是否有大事务长时间持有数据库连接。表 INNODB_TRX 记录了当前正在运行的事务信息，包括事务 ID、事务状态、事务开始时间、锁等待时间等。</li></ol><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">// 查看当前运行的所有事务</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> information_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">INNODB_TRX</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>查询结果如图。发现大量事务处于 LOCK WAIT 状态，只有一个事务处于 RUNNING 状态，被阻塞的事务都是在执行更新同一张表中的记录操作。</li></ul><figure><img src="https://s2.loli.net/2023/04/24/Oi3XjNGZFmCpwHy.png" alt="ba585b0c760dc1b474202c3cae27dd6c.png" tabindex="0" loading="lazy"><figcaption>ba585b0c760dc1b474202c3cae27dd6c.png</figcaption></figure><ol start="2"><li>进一步确认，查看当前数据库出现的锁信息。表 INNODB_LOCKS 记录了当前被锁定的对象以及相关的锁信息，包括事务 ID、锁类型、锁定模式、锁定对象等。<strong>注意 MySQL 8.0 版本之后没有此表</strong>。</li></ol><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">// 当前出现的锁</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> infromation_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">INNODB_LOCKS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">// MySQL </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">8</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.0之后执行下面语句</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> performance_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">data_locks</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>查询结果如图。锁的记录数正好对应上面查询的事务数，并且都持有 X 锁（排他锁）</li></ul><figure><img src="https://s2.loli.net/2022/12/22/iItP41AkOmcwzpH.png" alt="image-20221222142135836.png" tabindex="0" loading="lazy"><figcaption>image-20221222142135836.png</figcaption></figure><h2 id="问题定位-解决" tabindex="-1"><a class="header-anchor" href="#问题定位-解决"><span>问题定位&amp;解决</span></a></h2><p>至此，微服务获取不到数据库连接的问题原因已经明确：数据库中大量事务占用连接资源并处于阻塞状态，连接池最大连接数达到上限，无法获取新的连接来处理请求。因此只要找到事务被阻塞的原因并且解决，那么整个问题就解决了。</p><p>查看事务执行的 SQL 语句和对应的表结构，发现 where 条件后的字段没有添加索引。<strong>更新操作导致了锁表</strong>！！！</p><p>解决：为字段加上索引（一个索引引发这么大问题！）。</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">alter</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> table</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> 表名 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">add</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> 索引名(列名)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="问题" tabindex="-1"><a class="header-anchor" href="#问题"><span>问题</span></a></h2><ol><li><p>为什么服务运行了一段时间后，出现了这个问题？</p><p>服务刚运行的时候，连接池资源是够用的，业务也能正常使用。但是这条更新语句调用频繁，会不断产生新连接执行更新操作，然而同一时刻只能有一个事务执行（锁表），其他事务都会阻塞。阻塞的事务越来越多，事务又占有连接资源，可用的连接数越来越少，服务运行一段时间之后，就出现了问题。</p></li><li><p>update 没加索引，为什么会锁表？</p><p>数据库的事务隔离级别是“可重复读”。在 InnoDB 事务中，对记录加锁的基本单位是 next-key 锁（记录锁 + 间隙锁）。当 update 语句的 where 条件没有使用索引时，需要扫描整个表来找到满足 WHERE 条件的记录，于是就会对所有记录加上 next-key 锁，相当于把整个表锁住了。</p></li><li><p>update 加上索引，能避免锁表吗？</p><p>如果条件字段是唯一索引，next-key 锁会退化成记录锁，只会锁一条记录，不会锁表。</p><p>如果条件字段不是唯一索引，得看这条语句在执行过程中，优化器最终选择的是索引扫描，还是全表扫描，如果走了全表扫描，同样还是会锁表。</p></li></ol><h2 id="末尾" tabindex="-1"><a class="header-anchor" href="#末尾"><span>末尾</span></a></h2><p>实践是检验真理的唯一标准。问题排查与解决的过程也是理论应用于实战的过程。</p>`,31)]))}const r=s(n,[["render",l],["__file","update.html.vue"]]),d=JSON.parse('{"path":"/backend/practice/update.html","title":"Update 未加索引导致的微服务模块不可用","lang":"zh-CN","frontmatter":{"title":"Update 未加索引导致的微服务模块不可用","date":"2023-06-14T00:00:00.000Z","author":"Cleaner","categories":["Java"],"tags":["MySQL"],"description":"前言 开发环境一个微服务模块所有接口请求报错，对应页面无法访问。其他未涉及到该模块的接口和页面访问正常。 最近未更新过该服务，之前该服务也没有发生过不可用的情况。 错误排查 根据所观察到的现象和临时思考判断，可以确定是单个服务出现故障，具体原因尚不清楚。 查看日志 日志是我们排查问题时的第一个入口，根据日志信息，可以进一步定位问题。 登陆到远程服务器，...","head":[["meta",{"property":"og:url","content":"https://cleaner.love/backend/practice/update.html"}],["meta",{"property":"og:site_name","content":"Cleaner"}],["meta",{"property":"og:title","content":"Update 未加索引导致的微服务模块不可用"}],["meta",{"property":"og:description","content":"前言 开发环境一个微服务模块所有接口请求报错，对应页面无法访问。其他未涉及到该模块的接口和页面访问正常。 最近未更新过该服务，之前该服务也没有发生过不可用的情况。 错误排查 根据所观察到的现象和临时思考判断，可以确定是单个服务出现故障，具体原因尚不清楚。 查看日志 日志是我们排查问题时的第一个入口，根据日志信息，可以进一步定位问题。 登陆到远程服务器，..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://s2.loli.net/2023/04/24/Oi3XjNGZFmCpwHy.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-08-06T04:12:14.000Z"}],["meta",{"property":"article:author","content":"Cleaner"}],["meta",{"property":"article:tag","content":"MySQL"}],["meta",{"property":"article:published_time","content":"2023-06-14T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-08-06T04:12:14.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Update 未加索引导致的微服务模块不可用\\",\\"image\\":[\\"https://s2.loli.net/2023/04/24/Oi3XjNGZFmCpwHy.png\\",\\"https://s2.loli.net/2022/12/22/iItP41AkOmcwzpH.png\\"],\\"datePublished\\":\\"2023-06-14T00:00:00.000Z\\",\\"dateModified\\":\\"2025-08-06T04:12:14.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Cleaner\\"}]}"]]},"headers":[{"level":2,"title":"前言","slug":"前言","link":"#前言","children":[]},{"level":2,"title":"错误排查","slug":"错误排查","link":"#错误排查","children":[{"level":3,"title":"查看日志","slug":"查看日志","link":"#查看日志","children":[]},{"level":3,"title":"连接数据库","slug":"连接数据库","link":"#连接数据库","children":[]}]},{"level":2,"title":"问题定位&解决","slug":"问题定位-解决","link":"#问题定位-解决","children":[]},{"level":2,"title":"问题","slug":"问题","link":"#问题","children":[]},{"level":2,"title":"末尾","slug":"末尾","link":"#末尾","children":[]}],"git":{"createdTime":1754453534000,"updatedTime":1754453534000,"contributors":[{"name":"Cleaner","username":"Cleaner","email":"1414984960@qq.com","commits":1,"url":"https://github.com/Cleaner"}]},"readingTime":{"minutes":4.51,"words":1352},"filePathRelative":"backend/practice/update.md","localizedDate":"2023年6月14日","excerpt":"<h2>前言</h2>\\n<p>开发环境一个微服务模块所有接口请求报错，对应页面无法访问。其他未涉及到该模块的接口和页面访问正常。</p>\\n<p>最近未更新过该服务，之前该服务也没有发生过不可用的情况。</p>","autoDesc":true}');export{r as comp,d as data};
